name: AI-RDP

on:
  workflow_dispatch:

jobs:
  ai_rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Prepare RDP
        shell: powershell
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0
          netsh advfirewall firewall delete rule name="RDP-Open"
          netsh advfirewall firewall add rule name="RDP-Open" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create login user
        shell: powershell
        run: |
          $p = (32..126 | Get-Random -Count 14 | ForEach-Object {[char]$_}) -join ""
          $sp = ConvertTo-SecureString $p -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $sp -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          echo "PASS=$p" >> $env:GITHUB_ENV

      - name: Install Tailscale
        shell: powershell
        run: |
          curl.exe -L -o ts.msi "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Start-Process msiexec.exe -ArgumentList "/i ts.msi /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: powershell
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="win-ai-$env:GITHUB_RUN_ID"
          $ip=""
          while ($ip -eq "") {
            $ip = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4)
            Start-Sleep 3
          }
          echo "TSIP=$ip" >> $env:GITHUB_ENV

      - name: Install Ollama
        shell: powershell
        run: |
          curl.exe -L -o ollama.exe "https://ollama.com/download/windows"
          Start-Process .\ollama.exe -ArgumentList "/install" -Wait
          Start-Sleep -Seconds 10

      - name: Download AI models
        shell: powershell
        run: |
          ollama pull chatgpt-oss
          ollama pull deepseek-coder:1.3b
          ollama pull qwen2.5:1.5b

      - name: Start Ollama server
        shell: powershell
        run: |
          Start-Process -WindowStyle Hidden powershell "ollama serve"
          Start-Sleep 5

      - name: Install OpenWebUI
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          curl.exe -L https://github.com/open-webui/open-webui/releases/latest/download/open-webui-windows.zip -o ui.zip
          Expand-Archive ui.zip ./ui
          Start-Process -WindowStyle Hidden ./ui/open-webui.exe

      - name: Show access info
        shell: powershell
        run: |
          Write-Host "`n============================="
          Write-Host "   RDP Login Information"
          Write-Host "============================="
          Write-Host "IP: $env:TSIP"
          Write-Host "Username: RDP"
          Write-Host "Password: $env:PASS"
          Write-Host "OpenWebUI: http://$env:TSIP:8080"
          Write-Host "=============================`n"

      - name: Keep Alive
        shell: powershell
        run: |
          while ($true) {
            Write-Host "AI Server Active: $(Get-Date)"
            Start-Sleep 120
          }
